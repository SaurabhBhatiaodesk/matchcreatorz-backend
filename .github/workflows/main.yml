name: Deploy Backend Application

on:
  push:
    branches: [ "main" ]
  workflow_dispatch: 

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    env:
      NODE_ENV: production
      FCM_KEY_JSON: ${{ secrets.FCM_KEY_JSON }}

    steps:
      # 1Ô∏è‚É£ Checkout repo
      - name: Checkout code
        uses: actions/checkout@v3

      # 2Ô∏è‚É£ Deployment start log
      - name: Deployment Started
        run: |
          echo "üöÄ Backend deployment started at $(date)"
          echo "Repository: ${{ github.repository }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"

      # 3Ô∏è‚É£ Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20.15.1'
          cache: 'npm'

      # 4Ô∏è‚É£ Install build tools for native modules
      - name: Install build tools
        run: sudo apt-get update && sudo apt-get install -y build-essential python3

      # 5Ô∏è‚É£ Install dependencies
      - name: Install dependencies
        run: |
          echo "üì¶ Installing backend dependencies..."
          npm ci
          echo "‚úÖ Backend dependencies installed successfully"

      # 6Ô∏è‚É£ Setup FCM key file from secret
      - name: Create FCM key file
        run: |
          echo "üîê Creating FCM key file from secret"
          mkdir -p common/utils
          echo "$FCM_KEY_JSON" > common/utils/fcmkey.json
          echo "‚úÖ fcmkey.json created"

      # 7Ô∏è‚É£ Build NestJS monorepo
      - name: Build application (NestJS Monorepo)
        run: |
          echo "üî® Building NestJS monorepo (user, admin, socket)"
          npm run build

      # 8Ô∏è‚É£ Clean unnecessary files before deployment
      - name: Prepare deployment files
        run: |
          echo "üßπ Cleaning up files for deployment..."
          rm -rf .git node_modules/.cache
          echo "‚úÖ Backend deployment files ready"

      # 9Ô∏è‚É£ Fix remote permissions
      - name: Fix remote permissions
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY_LIVE }}
          script: |
            echo "üîê Fixing remote permissions..."
            sudo chown -R ${{ secrets.SERVER_USER }}:${{ secrets.SERVER_USER }} /home/ubuntu/MatchcreatorsBackend/
            sudo chmod -R 755 /home/ubuntu/MatchcreatorsBackend/
            echo "‚úÖ Permissions fixed successfully"

      # üîü Deploy via Rsync
      - name: Deploy via Rsync 
        uses: easingthemes/ssh-deploy@main
        with:
          SSH_PRIVATE_KEY: ${{ secrets.SERVER_SSH_KEY_LIVE }}
          REMOTE_HOST: ${{ secrets.SERVER_IP }}
          REMOTE_USER: ${{ secrets.SERVER_USER }}
          TARGET: /home/ubuntu/MatchcreatorsBackend/
          ARGS: "-rlgoDzvc --chmod=Du=rwx,Dg=rx,Do=rx,Fu=rw,Fg=r,Fo=r --no-perms --no-owner --no-group --exclude=node_modules --exclude=.git --exclude=.next --exclude=dist"
          BEFORE_RSYNC: echo "üöÄ Starting file deployment to server..."
          AFTER_RSYNC: echo "‚úÖ Files deployed successfully to server!"

      # 1Ô∏è‚É£1Ô∏è‚É£ Install server dependencies
      - name: Install server dependencies
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY_LIVE }}
          script: |
            echo "üì¶ Installing server dependencies..."
            cd /home/ubuntu/MatchcreatorsBackend/
            npm ci --production
            echo "‚úÖ Server dependencies installed successfully"

      # 1Ô∏è‚É£2Ô∏è‚É£ Restart backend application with PM2
      - name: Restart backend application
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY_LIVE }}
          script: |
            echo "üîÑ Restarting backend application..."
            cd /home/ubuntu/MatchcreatorsBackend/
            pm2 reload matchcreatorsapp-dev-api || pm2 start "npm run start" --name matchcreatorsapp-dev-api
            pm2 reload matchcreatorsapp-dev-admin || pm2 start "npm run start" --name matchcreatorsapp-dev-admin
            pm2 reload matchcreatorsapp-dev-socket || pm2 start "npm run start" --name matchcreatorsapp-dev-socket
            pm2 save
            echo "‚úÖ Backend application restarted successfully"

      # 1Ô∏è‚É£3Ô∏è‚É£ Health check
      - name: Health check
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY_LIVE }}
          script: |
            echo "üè• Performing health check..."
            sleep 5
            pm2 status
            echo "üéâ Backend deployment completed successfully!"
            echo "üìä Deployment Summary:"
            echo "  - Repository: ${{ github.repository }}"
            echo "  - Branch: ${{ github.ref_name }}"
            echo "  - Commit: ${{ github.sha }}"
            echo "  - Deployed at: $(date)"
